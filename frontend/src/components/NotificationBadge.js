import React, { useState, useEffect } from 'react';\nimport { Link } from 'react-router-dom';\nimport { BellIcon } from '@heroicons/react/24/outline';\nimport { useAuth } from '../context/AuthContext';\nimport { notificationsAPI } from '../api/notifications';\nimport toast from 'react-hot-toast';\n\nconst NotificationBadge = () => {\n  const { user } = useAuth();\n  const [unreadCount, setUnreadCount] = useState(0);\n  const [isOpen, setIsOpen] = useState(false);\n  const [notifications, setNotifications] = useState([]);\n  const [isLoading, setIsLoading] = useState(false);\n\n  useEffect(() => {\n    if (user) {\n      fetchUnreadCount();\n      const interval = setInterval(fetchUnreadCount, 30000); // Refresh every 30 seconds\n      return () => clearInterval(interval);\n    }\n  }, [user]);\n\n  const fetchUnreadCount = async () => {\n    try {\n      const response = await notificationsAPI.getUnreadCount();\n      setUnreadCount(response.data.count);\n    } catch (error) {\n      console.error('Failed to fetch unread count:', error);\n    }\n  };\n\n  const fetchNotifications = async () => {\n    if (isOpen) return; // Don't fetch if already open\n    \n    setIsLoading(true);\n    try {\n      const response = await notificationsAPI.getNotifications({ limit: 10, isRead: false });\n      setNotifications(response.data.notifications);\n      setIsOpen(true);\n    } catch (error) {\n      toast.error('Failed to load notifications');\n    } finally {\n      setIsLoading(false);\n    }\n  };\n\n  const markAsRead = async (notificationId) => {\n    try {\n      await notificationsAPI.markAsRead(notificationId);\n      setNotifications(notifications.filter(n => n._id !== notificationId));\n      setUnreadCount(prev => Math.max(0, prev - 1));\n    } catch (error) {\n      toast.error('Failed to mark notification as read');\n    }\n  };\n\n  const markAllAsRead = async () => {\n    try {\n      await notificationsAPI.markAllAsRead();\n      setNotifications([]);\n      setUnreadCount(0);\n      toast.success('All notifications marked as read');\n    } catch (error) {\n      toast.error('Failed to mark all notifications as read');\n    }\n  };\n\n  const getNotificationIcon = (type) => {\n    switch (type) {\n      case 'low_stock':\n        return (\n          <div className="flex-shrink-0 p-1 bg-warning-100 rounded-full">\n            <svg className="h-4 w-4 text-warning-600" fill="currentColor" viewBox="0 0 20 20">\n              <path fillRule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clipRule="evenodd" />\n            </svg>\n          </div>\n        );\n      case 'expiry_alert':\n        return (\n          <div className="flex-shrink-0 p-1 bg-danger-100 rounded-full">\n            <svg className="h-4 w-4 text-danger-600" fill="currentColor" viewBox="0 0 20 20">\n              <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />\n            </svg>\n          </div>\n        );\n      case 'order_update':\n        return (\n          <div className="flex-shrink-0 p-1 bg-primary-100 rounded-full">\n            <svg className="h-4 w-4 text-primary-600" fill="currentColor" viewBox="0 0 20 20">\n              <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z" />\n              <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z" />\n            </svg>\n          </div>\n        );\n      default:\n        return (\n          <div className="flex-shrink-0 p-1 bg-secondary-100 rounded-full">\n            <svg className="h-4 w-4 text-secondary-600" fill="currentColor" viewBox="0 0 20 20">\n              <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />\n            </svg>\n          </div>\n        );\n    }\n  };\n\n  const formatTime = (date) => {\n    const now = new Date();\n    const notificationDate = new Date(date);\n    const diffInMinutes = Math.floor((now - notificationDate) / (1000 * 60));\n    \n    if (diffInMinutes < 1) return 'Just now';\n    if (diffInMinutes < 60) return `${diffInMinutes}m ago`;\n    if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`;\n    return `${Math.floor(diffInMinutes / 1440)}d ago`;\n  };\n\n  return (\n    <div className="relative">\n      <button\n        onClick={fetchNotifications}\n        className="relative p-2 text-secondary-600 hover:text-secondary-900 focus:outline-none focus:ring-2 focus:ring-primary-500 rounded-lg hover:bg-secondary-100 transition-colors duration-200"\n      >\n        <BellIcon className="h-6 w-6" />\n        {unreadCount > 0 && (\n          <span className="absolute top-1 right-1 h-2 w-2 bg-danger-500 rounded-full animate-pulse" />\n        )}\n      </button>\n\n      {isOpen && (\n        <div className="absolute right-0 mt-2 w-80 bg-white rounded-lg shadow-lg border border-secondary-200 z-50">\n          <div className="p-4 border-b border-secondary-200">\n            <div className="flex items-center justify-between">\n              <h3 className="text-lg font-semibold text-secondary-900">Notifications</h3>\n              {notifications.length > 0 && (\n                <button\n                  onClick={markAllAsRead}\n                  className="text-sm text-primary-600 hover:text-primary-700 font-medium"\n                >\n                  Mark all read\n                </button>\n              )}\n            </div>\n          </div>\n\n          <div className="max-h-96 overflow-y-auto">\n            {isLoading ? (\n              <div className="p-4 text-center text-secondary-500">\n                Loading notifications...\n              </div>\n            ) : notifications.length === 0 ? (\n              <div className="p-4 text-center text-secondary-500">\n                No new notifications\n              </div>\n            ) : (\n              <div className="divide-y divide-secondary-100">\n                {notifications.map((notification) => (\n                  <div\n                    key={notification._id}\n                    className="p-4 hover:bg-secondary-50 transition-colors duration-200 cursor-pointer"\n                    onClick={() => markAsRead(notification._id)}\n                  >\n                    <div className="flex items-start space-x-3">\n                      {getNotificationIcon(notification.type)}\n                      <div className="flex-1 min-w-0">\n                        <p className="text-sm text-secondary-900 font-medium">\n                          {notification.title}\n                        </p>\n                        <p className="text-sm text-secondary-600 mt-1">\n                          {notification.message}\n                        </p>\n                        <p className="text-xs text-secondary-500 mt-1">\n                          {formatTime(notification.createdAt)}\n                        </p>\n                      </div>\n                    </div>\n                  </div>\n                ))}\n              </div>\n            )}\n          </div>\n\n          <div className="p-3 border-t border-secondary-200 bg-secondary-50 rounded-b-lg">\n            <Link\n              to="/notifications"\n              className="block text-center text-sm text-primary-600 hover:text-primary-700 font-medium"\n              onClick={() => setIsOpen(false)}\n            >\n              View all notifications\n            </Link>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n};\n\nexport default NotificationBadge;
